# Sistema de Exporta√ß√£o de Matr√≠culas

## Vis√£o Geral

O sistema de exporta√ß√£o de matr√≠culas foi desenvolvido para permitir a extra√ß√£o completa de dados das matr√≠culas em m√∫ltiplos formatos, incluindo todas as colunas dispon√≠veis no sistema, inclusive as relacionadas ao Google Drive.

## Funcionalidades Principais

### ‚úÖ **Exporta√ß√£o Completa**
- **TODAS as colunas** dispon√≠veis no sistema
- **Colunas do Google Drive** inclu√≠das
- **M√∫ltiplos formatos**: CSV, Excel, JSON, PDF
- **Filtros avan√ßados** para exporta√ß√µes espec√≠ficas
- **Ordena√ß√£o personalizada** por qualquer coluna
- **Limite configur√°vel** de registros (at√© 10.000)

### ‚úÖ **Interface Web**
- Formul√°rio intuitivo com todas as op√ß√µes
- Sele√ß√£o de colunas organizadas por categoria
- Filtros visuais para facilitar a busca
- Preview em tempo real das configura√ß√µes
- Download direto dos arquivos gerados

### ‚úÖ **Processamento Ass√≠ncrono**
- Jobs em fila para exporta√ß√µes grandes
- Notifica√ß√µes por e-mail ao concluir
- Monitoramento de status em tempo real
- Limpeza autom√°tica de arquivos antigos

### ‚úÖ **Comando CLI**
- Exporta√ß√£o via terminal
- Filtros via JSON
- Configura√ß√£o completa via par√¢metros
- Ideal para automa√ß√µes e scripts

## Estrutura de Arquivos

```
app/
‚îú‚îÄ‚îÄ Http/
‚îÇ   ‚îú‚îÄ‚îÄ Controllers/Admin/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ MatriculaExportController.php    # Controller principal
‚îÇ   ‚îî‚îÄ‚îÄ Requests/
‚îÇ       ‚îî‚îÄ‚îÄ MatriculaExportRequest.php       # Valida√ß√£o de dados
‚îú‚îÄ‚îÄ Services/
‚îÇ   ‚îî‚îÄ‚îÄ MatriculaExportService.php           # L√≥gica de neg√≥cio
‚îú‚îÄ‚îÄ Jobs/
‚îÇ   ‚îî‚îÄ‚îÄ ProcessMatriculaExport.php           # Processamento ass√≠ncrono
‚îú‚îÄ‚îÄ DTOs/
‚îÇ   ‚îî‚îÄ‚îÄ MatriculaExportData.php              # Transfer√™ncia de dados
‚îú‚îÄ‚îÄ Mail/
‚îÇ   ‚îî‚îÄ‚îÄ MatriculaExportCompleted.php         # E-mail de notifica√ß√£o
‚îî‚îÄ‚îÄ Console/Commands/
    ‚îî‚îÄ‚îÄ ExportMatriculasCommand.php          # Comando CLI

resources/views/
‚îî‚îÄ‚îÄ admin/matriculas/
    ‚îî‚îÄ‚îÄ exportar.blade.php                   # Interface web

resources/views/emails/
‚îî‚îÄ‚îÄ matricula-export-completed.blade.php     # Template do e-mail
```

## Colunas Dispon√≠veis para Exporta√ß√£o

### üîç **Identifica√ß√£o**
- `id` - ID √∫nico da matr√≠cula
- `inscricao_id` - ID da inscri√ß√£o relacionada
- `numero_matricula` - N√∫mero da matr√≠cula

### üë§ **Dados Pessoais**
- `nome_completo` - Nome completo do aluno
- `data_nascimento` - Data de nascimento
- `cpf` - CPF do aluno
- `rg` - RG do aluno
- `orgao_emissor` - √ìrg√£o emissor do RG
- `sexo` - Sexo (M/F)
- `estado_civil` - Estado civil
- `nacionalidade` - Nacionalidade
- `naturalidade` - Naturalidade

### üìû **Contato**
- `cep` - CEP do endere√ßo
- `logradouro` - Logradouro
- `numero` - N√∫mero do endere√ßo
- `complemento` - Complemento do endere√ßo
- `bairro` - Bairro
- `cidade` - Cidade
- `estado` - Estado
- `telefone_fixo` - Telefone fixo
- `telefone_celular` - Telefone celular
- `email` - E-mail

### üë®‚Äçüë©‚Äçüëß‚Äçüë¶ **Familiares**
- `nome_pai` - Nome do pai
- `nome_mae` - Nome da m√£e

### üéì **Dados Acad√™micos**
- `modalidade` - Modalidade de ensino
- `curso` - Nome do curso
- `ultima_serie` - √öltima s√©rie cursada
- `ano_conclusao` - Ano de conclus√£o
- `escola_origem` - Escola de origem

### üìä **Status e Configura√ß√£o**
- `status` - Status da matr√≠cula
- `escola_parceira` - Se √© escola parceira
- `parceiro_id` - ID do parceiro

### üí∞ **Pagamento**
- `forma_pagamento` - Forma de pagamento
- `tipo_boleto` - Tipo de boleto
- `valor_total_curso` - Valor total do curso
- `valor_matricula` - Valor da matr√≠cula
- `valor_mensalidade` - Valor da mensalidade
- `numero_parcelas` - N√∫mero de parcelas
- `dia_vencimento` - Dia de vencimento
- `forma_pagamento_mensalidade` - Forma de pagamento da mensalidade
- `parcelas_ativas` - Parcelas ativas
- `parcelas_geradas` - Parcelas geradas
- `parcelas_pagas` - Parcelas pagas
- `percentual_juros` - Percentual de juros
- `desconto` - Desconto aplicado

### üìÑ **Documentos**
- `doc_rg_cpf` - Documentos RG/CPF
- `doc_comprovante` - Comprovante
- `doc_historico` - Hist√≥rico escolar
- `doc_certificado` - Certificado
- `doc_outros` - Outros documentos

### ‚òÅÔ∏è **Google Drive**
- `google_drive_folder_id` - ID da pasta no Google Drive

### üìù **Observa√ß√µes e Metadados**
- `observacoes` - Observa√ß√µes gerais
- `created_at` - Data de cria√ß√£o
- `updated_at` - Data de atualiza√ß√£o
- `deleted_at` - Data de exclus√£o (soft delete)
- `created_by` - Usu√°rio que criou
- `updated_by` - Usu√°rio que atualizou

## Filtros Dispon√≠veis

### üîç **Filtros B√°sicos**
- `status` - Filtrar por status da matr√≠cula
- `parceiro_id` - Filtrar por parceiro espec√≠fico
- `modalidade` - Filtrar por modalidade de ensino
- `curso` - Buscar por nome do curso (busca parcial)

### üìÖ **Filtros de Data**
- `data_inicio` - Data de in√≠cio para filtro
- `data_fim` - Data de fim para filtro

### üí∞ **Filtros de Valor**
- `valor_min` - Valor m√≠nimo do curso
- `valor_max` - Valor m√°ximo do curso

## Formatos de Exporta√ß√£o

### üìä **CSV**
- Formato padr√£o para planilhas
- Cabe√ßalhos configur√°veis
- Codifica√ß√£o UTF-8
- Separador de campos configur√°vel

### üìà **Excel**
- Formato .xlsx compat√≠vel com Excel
- M√∫ltiplas abas se necess√°rio
- Formata√ß√£o autom√°tica de dados

### üîß **JSON**
- Formato estruturado para APIs
- Dados aninhados preservados
- Ideal para integra√ß√µes

### üìÑ **PDF**
- Relat√≥rio formatado
- Cabe√ßalhos e rodap√©s
- Pagina√ß√£o autom√°tica

## Uso da Interface Web

### 1. **Acesso**
- Navegue para `/dashboard/matriculas/exportar`
- Ou clique no bot√£o "Exportar" na listagem de matr√≠culas

### 2. **Configura√ß√£o**
- Selecione o formato desejado
- Escolha as colunas para exportar
- Configure filtros se necess√°rio
- Defina ordena√ß√£o e limite

### 3. **Execu√ß√£o**
- Clique em "Iniciar Exporta√ß√£o"
- Aguarde o processamento
- Fa√ßa download do arquivo gerado

## Uso via Comando CLI

### üìã **Comando B√°sico**
```bash
php artisan matriculas:export csv
```

### üîç **Com Filtros**
```bash
php artisan matriculas:export csv --filters='{"status":"ativo","parceiro_id":1}'
```

### üìä **Com Colunas Espec√≠ficas**
```bash
php artisan matriculas:export excel --columns="nome_completo,cpf,email,curso"
```

### üîÑ **Com Ordena√ß√£o**
```bash
php artisan matriculas:export json --sort-by="nome_completo" --sort-direction="asc"
```

### üìè **Com Limite**
```bash
php artisan matriculas:export pdf --limit=500
```

### üöÄ **Exporta√ß√£o Completa**
```bash
php artisan matriculas:export csv \
  --filters='{"status":"ativo"}' \
  --columns="nome_completo,cpf,email,curso,google_drive_folder_id" \
  --sort-by="created_at" \
  --sort-direction="desc" \
  --limit=2000
```

## Configura√ß√£o

### ‚öôÔ∏è **Vari√°veis de Ambiente**
```env
# Configura√ß√£o de filas
QUEUE_CONNECTION=database

# Configura√ß√£o de armazenamento
FILESYSTEM_DISK=local
```

### üîß **Configura√ß√£o de Filas**
```bash
# Criar tabelas de fila
php artisan queue:table
php artisan queue:failed-table

# Executar worker de fila
php artisan queue:work --queue=exports
```

## Monitoramento e Manuten√ß√£o

### üìä **Status das Exporta√ß√µes**
- Verificar status: `/dashboard/matriculas/exportar/status`
- Limpeza autom√°tica: `/dashboard/matriculas/exportar/cleanup`

### üßπ **Limpeza Autom√°tica**
- Arquivos antigos s√£o removidos automaticamente ap√≥s 7 dias
- Comando manual: `php artisan matriculas:export:cleanup`

### üìß **Notifica√ß√µes**
- E-mail enviado ao concluir exporta√ß√£o
- E-mail de erro se houver falha
- Configur√°vel por exporta√ß√£o

## Performance e Limites

### ‚ö° **Processamento**
- **Exporta√ß√µes pequenas** (‚â§1000 registros): Processamento imediato
- **Exporta√ß√µes grandes** (>1000 registros): Processamento ass√≠ncrono
- **Timeout**: 30 minutos por job
- **Retry**: 3 tentativas em caso de falha

### üìè **Limites**
- **M√°ximo de registros**: 10.000 por exporta√ß√£o
- **Tamanho de arquivo**: Sem limite (depende do servidor)
- **Tempo de processamento**: At√© 30 minutos

## Seguran√ßa e Permiss√µes

### üîê **Autentica√ß√£o**
- Usu√°rio deve estar logado
- Permiss√£o `matriculas.index` obrigat√≥ria

### üõ°Ô∏è **Valida√ß√£o**
- Valida√ß√£o de formato de arquivo
- Valida√ß√£o de filtros e par√¢metros
- Sanitiza√ß√£o de dados de entrada

### üìÅ **Armazenamento**
- Arquivos salvos em `storage/app/exports/`
- Acesso restrito via middleware de autentica√ß√£o
- Download seguro via controller

## Troubleshooting

### ‚ùå **Problemas Comuns**

#### Exporta√ß√£o n√£o inicia
- Verificar permiss√µes do usu√°rio
- Verificar configura√ß√£o de filas
- Verificar logs de erro

#### Arquivo n√£o √© gerado
- Verificar espa√ßo em disco
- Verificar permiss√µes de escrita
- Verificar logs de erro

#### Filtros n√£o funcionam
- Verificar sintaxe dos filtros
- Verificar nomes das colunas
- Verificar valores dos filtros

### üîç **Logs e Debug**
```bash
# Ver logs de exporta√ß√£o
tail -f storage/logs/laravel.log | grep "export"

# Ver jobs em fila
php artisan queue:monitor

# Ver jobs falhados
php artisan queue:failed
```

## Exemplos de Uso

### üìä **Relat√≥rio de Matr√≠culas por Parceiro**
```bash
php artisan matriculas:export csv \
  --filters='{"parceiro_id":5}' \
  --columns="nome_completo,cpf,curso,status,valor_total_curso,created_at" \
  --sort-by="created_at" \
  --sort-direction="desc"
```

### üìà **Relat√≥rio Financeiro**
```bash
php artisan matriculas:export excel \
  --filters='{"status":"ativo"}' \
  --columns="nome_completo,cpf,valor_total_curso,valor_matricula,valor_mensalidade,numero_parcelas,parcelas_pagas" \
  --sort-by="valor_total_curso" \
  --sort-direction="desc"
```

### üîç **Relat√≥rio de Documentos**
```bash
php artisan matriculas:export json \
  --columns="nome_completo,cpf,doc_rg_cpf,doc_comprovante,doc_historico,doc_certificado,google_drive_folder_id" \
  --filters='{"status":"ativo"}'
```

## Contribui√ß√£o

### üöÄ **Melhorias Futuras**
- Suporte a mais formatos (XML, YAML)
- Exporta√ß√£o para Google Sheets
- Relat√≥rios agendados
- Templates personaliz√°veis
- Integra√ß√£o com sistemas externos

### üêõ **Reportar Bugs**
- Criar issue no reposit√≥rio
- Incluir logs de erro
- Descrever passos para reproduzir

### üí° **Sugest√µes**
- Abrir discuss√£o no reposit√≥rio
- Descrever caso de uso
- Propor solu√ß√£o se poss√≠vel

---

**Desenvolvido para o projeto EC - Sistema Educacional Completo**

Este sistema √© parte do projeto EC e segue as mesmas pol√≠ticas de licenciamento.
